title: JVM内存管理
date: 2019-09-11 20:53:08
tags:
    - Java
    - JVM
categories:
    - 后端
---

# JVM内存管理

作为三大工业级别语言之一的JAVA如此受企业青睐有加，离不开她背后JVM的默默复出。只是由于JAVA过于成功以至于我们常常忘了JVM平台上还运行着像Clojure/Groovy/Kotlin/Scala/JRuby/Jython这样的语言。我们享受着JVM带来跨平台“一次编译到处执行”的便利和自动内存回收的安逸。

JVM是JAVA的核心基础，也是掌握JAVA语言的重难点，如果没有理解JVM的知识体系，就不要说自己是JAVA高手。最近我打算换工作，所以来重新回顾JVM的相关知识，为面试准备。JVM体系内知识点很多，通过以下关键词来简单概括下：

```类结构```，```类加载器```，```加载```，```链接```，```初始化```，```双亲委派```，```热部署```，```隔离```，```堆```，```栈```，```方法区```，```计数器```，```内存回收```，```执行引擎```，```调优工具```，```JVMTI```，```JDWP```，```JDI```，```热替换```，```字节码```，```ASM```，```CGLIB```，```DCEVM```

本文从JVM的内存结构入手，介绍JVM逻辑内存的分布和管理方式，同时列举常用的JVM调优工具和使用方法。

## 内存结构

### 逻辑分区

JVM内存从应用逻辑上可分为如下区域：

#### 程序计数器

程序计数器是一块较小的内存空间，它可以看做是当前线程所执行的字节码的行号指示器，每个线程都需要一个程序计数器。在虚拟机的概念模型里（仅仅是概念模型，各种虚拟机可能会通过一些更高效的方式去实现），字节码解释器工作时，就是通过改变这个计数器的值来选取下一条需要执行的字节码指令，```分支```、```循环```、```跳准```、```异常处理```、```线程恢复```等基础功能都需要依赖这个计数器来完成。

简单理解就是程序计数器保证了程序的正常执行。

#### 虚拟机栈

方法执行时创建栈帧(存储局部变量，操作栈，动态链接，方法出口)编译时期就能确定占用空间大小，线程请求的栈深度超过jvm运行深度时抛StackOverflowError，当jvm栈无法申请到空闲内存时抛OutOfMemoryError，**通过-Xss,-Xsx来配置初始内存**

#### 本地方法栈

执行本地方法，如操作系统native接口

#### 堆

存放对象的空间，**通过-Xmx,-Xms配置堆大小**，当堆无法申请到内存时抛OutOfMemoryError

#### 方法区

存储类数据，常量，常量池，静态变量，通过MaxPermSize参数配置

#### 对象访问

初始化一个对象，其引用存放于栈帧，对象存放于堆内存，对象包含属性信息和该对象父类、接口等类型数据（该类型数据存储在方法区空间，对象拥有类型数据的地址）

### 内存模型

#### 堆内存

堆内存是运行时的数据区，从中分配所有的Java类实例和数组的内存，可以理解为目标应用依赖的对象。堆在JVM启动时创建，并在应用程序运行时可能会增大或减小。可以使用``-Xms```选项指定堆的大小。堆可以是固定大小或可变大小，具体取决于垃圾收集策略。可以使用```-Xmx```选项设置最大堆大小。默认情况下，最大堆大小设置为64M。

JVM堆内存在物理上分为两部分：```新生代```和```老年代```。新生代是为分配新对象而保留堆空间。当新生代占用完时，Minor GC垃圾收集器会对新生代区域执行垃圾回收动作。其中在新生代中生活了足够长的所有对象被迁移到老生代，从而释放新生代空间以进行更多的对象分配。此垃圾收集称为```Minor GC```。新生代分分为三个子区域：```伊甸园Eden区```和两个``幸存区S0```和```S1``。



References:
 
- https://mp.weixin.qq.com/s/3_DEPdZTnGmdGBd5iTrVjQ
- https://www.cnblogs.com/manayi/p/9290490.html